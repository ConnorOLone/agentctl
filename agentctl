#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
agentctl - git worktree bootstrapper

Commands:
  agentctl init [--count N] [--prefix agent] [--workdir worktrees] [--base origin/main]
  agentctl list
  agentctl clean
  agentctl rm <name>

Examples:
  agentctl init --count 3
  agentctl init --count 2 --prefix agent --workdir worktrees --base origin/main
  agentctl rm task-2
USAGE
}

die() { echo "agentctl: $*" >&2; exit 1; }

repo_root() {
  git rev-parse --show-toplevel 2>/dev/null || true
}

ensure_in_repo() {
  local root
  root="$(repo_root)"
  [[ -n "$root" ]] || die "Not inside a git repository."
  echo "$root"
}

default_branch() {
  # Prefer origin/HEAD -> origin/main or origin/master if available.
  local ref
  ref="$(git symbolic-ref -q refs/remotes/origin/HEAD 2>/dev/null || true)"
  if [[ -n "$ref" ]]; then
    echo "${ref#refs/remotes/}"
  else
    echo "origin/main"
  fi
}

cmd="${1:-}"
shift || true

case "$cmd" in
  init)
    count=2
    prefix="agent"
    workdir="worktrees"
    base=""

    while [[ $# -gt 0 ]]; do
      case "$1" in
        --count) count="$2"; shift 2;;
        --prefix) prefix="$2"; shift 2;;
        --workdir) workdir="$2"; shift 2;;
        --base) base="$2"; shift 2;;
        -h|--help) usage; exit 0;;
        *) die "Unknown argument: $1";;
      esac
    done

    root="$(ensure_in_repo)"
    cd "$root"

    [[ "$count" =~ ^[0-9]+$ ]] || die "--count must be an integer."
    [[ "$count" -ge 1 ]] || die "--count must be >= 1."

    # Determine base ref if not provided
    if [[ -z "$base" ]]; then
      base="$(default_branch)"
    fi

    echo "Repo root: $root"
    echo "Worktrees dir: $workdir"
    echo "Branch prefix: $prefix"
    echo "Base ref: $base"
    echo ""

    mkdir -p "$workdir"

    echo "Pruning stale worktrees..."
    git worktree prune

    echo "Fetching origin..."
    git fetch origin --prune

    # Ensure base exists
    git show-ref --verify --quiet "refs/remotes/${base}" || \
      git show-ref --verify --quiet "refs/remotes/${base#origin/}" || true

    echo "Creating worktrees..."
    for i in $(seq 1 "$count"); do
      name="task-$i"
      branch="$prefix/$name"
      path="$workdir/$name"

      if [[ -d "$path" ]]; then
        echo "  Skip: $path already exists"
        continue
      fi

      # Avoid branch collision
      if git show-ref --verify --quiet "refs/heads/$branch"; then
        die "Branch already exists: $branch (choose another prefix/name or delete the branch)"
      fi

      echo "  + $path  (branch $branch)"
      git worktree add -b "$branch" "$path" "$base"
    done

    echo ""
    echo "Current worktrees:"
    git worktree list
    ;;

  list)
    root="$(ensure_in_repo)"
    cd "$root"
    git worktree list
    ;;

  clean)
    root="$(ensure_in_repo)"
    cd "$root"
    git worktree prune
    echo "Pruned. Current worktrees:"
    git worktree list
    ;;

  rm)
    name="${1:-}"
    [[ -n "$name" ]] || die "Usage: agentctl rm <name> (e.g. agentctl rm task-2)"
    shift || true

    root="$(ensure_in_repo)"
    cd "$root"

    # Find workdir that contains this name (default worktrees/name)
    # If user passes a path, respect it
    if [[ "$name" == */* || "$name" == .*/* ]]; then
      path="$name"
    else
      path="worktrees/$name"
    fi

    [[ -d "$path" ]] || die "No such worktree directory: $path"

    echo "Removing worktree: $path"
    git worktree remove --force "$path"

    echo "Pruning..."
    git worktree prune

    echo "Done. Current worktrees:"
    git worktree list
    ;;

  ""|-h|--help)
    usage
    ;;

  *)
    die "Unknown command: $cmd (use --help)"
    ;;
esac
